/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/strings/capitalize","sap/base/util/isPlainObject","sap/base/util/UriParameters","sap/base/Log","sap/m/MessageBox","sap/m/MessageToast","sap/ui/thirdparty/jquery","sap/ui/base/ManagedObject","sap/ui/core/BusyIndicator","sap/ui/dt/DesignTime","sap/ui/dt/DOMUtil","sap/ui/dt/ElementUtil","sap/ui/dt/Overlay","sap/ui/dt/OverlayRegistry","sap/ui/dt/Util","sap/ui/events/KeyCodes","sap/ui/fl/write/api/Version","sap/ui/fl/apply/api/SmartVariantManagementApplyAPI","sap/ui/fl/write/api/ControlPersonalizationWriteAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/write/api/ReloadInfoAPI","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/write/api/TranslationAPI","sap/ui/fl/Layer","sap/ui/fl/registry/Settings","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ui/rta/appVariant/Feature","sap/ui/rta/command/BaseCommand","sap/ui/rta/command/LREPSerializer","sap/ui/rta/command/Stack","sap/ui/rta/service/index","sap/ui/rta/toolbar/Fiori","sap/ui/rta/toolbar/FioriLike","sap/ui/rta/toolbar/Personalization","sap/ui/rta/toolbar/Standalone","sap/ui/rta/util/changeVisualization/ChangeVisualization","sap/ui/rta/util/PluginManager","sap/ui/rta/util/PopupManager","sap/ui/rta/util/ReloadManager","sap/ui/rta/util/ServiceEventBus","sap/ui/rta/util/validateFlexEnabled","sap/ui/rta/Utils","sap/ui/Device"],function(e,t,i,n,o,r,jQuery,a,s,l,h,d,u,c,p,g,f,v,b,m,y,_,S,C,R,P,E,A,T,M,w,D,I,O,V,x,L,U,k,F,z,N,B,G,K,j){"use strict";var W="STARTING";var H="STARTED";var Y="STOPPED";var Z="FAILED";var q="SERVICE_STARTING";var Q="SERVICE_STARTED";var J="SERVICE_FAILED";var X=a.extend("sap.ui.rta.RuntimeAuthoring",{metadata:{library:"sap.ui.rta",associations:{rootControl:{type:"sap.ui.base.ManagedObject"}},properties:{customFieldUrl:"string",showCreateCustomField:"boolean",showToolbars:{type:"boolean",defaultValue:true},triggeredFromDialog:{type:"boolean",defaultValue:false},showWindowUnloadDialog:{type:"boolean",defaultValue:true},commandStack:{type:"any"},flexSettings:{type:"object",defaultValue:{layer:R.CUSTOMER,developerMode:true}},mode:{type:"string",defaultValue:"adaptation"},metadataScope:{type:"string",defaultValue:"default"}},events:{start:{parameters:{editablePluginsCount:{type:"int"}}},stop:{},failed:{parameters:{error:{type:"any"}}},selectionChange:{parameters:{selection:{type:"sap.ui.dt.Overlay[]"}}},modeChanged:{},undoRedoStackModified:{}}},_sAppTitle:null,_dependents:null,_sStatus:Y,_bNavigationModeWarningShown:false,constructor:function(){a.apply(this,arguments);this._dependents={};this._mServices={};this._mUShellServices={};this._pElementModified=Promise.resolve();this.addDependent(new F,"pluginManager");this.addDependent(new z,"popupManager");if(this.getShowToolbars()){this.getPopupManager().attachOpen(this.onPopupOpen,this);this.getPopupManager().attachClose(this.onPopupClose,this);this.addDependent(new k,"changeVisualization")}if(window.parent!==window){this.startService("receiver")}this.startService("supportTools");this._loadUShellServicesPromise=E.getUShellServices(["URLParsing","AppLifeCycle","CrossApplicationNavigation"]).then(function(e){this._mUShellServices=e;N.setUShellServices(e)}.bind(this))}});X.prototype._shouldValidateFlexEnabled=function(){var e=i.fromQuery(window.location.search).get("sap-ui-rta-skip-flex-validation");return P.getInstance().then(function(t){return!t.isCustomerSystem()&&e!=="true"})};X.prototype.addDependent=function(t,i,n){n=typeof n==="undefined"?true:!!n;if(!(i in this._dependents)){if(i&&n){this["get"+e(i,0)]=this.getDependent.bind(this,i)}this._dependents[i||t.getId()]=t}else{throw p.createError("RuntimeAuthoring#addDependent",p.printf("Can't add dependency with same key '{0}'",i),"sap.ui.rta")}};X.prototype.getDependent=function(e){return this._dependents[e]};X.prototype.getDependents=function(){return this._dependents};X.prototype.removeDependent=function(e){delete this._dependents[e]};X.prototype.onPopupOpen=function(e){var t=e.getParameters().getSource();if(t.isA("sap.m.Dialog")&&this.getToolbar().type==="fiori"){this.getToolbar().setColor("contrast")}this.getToolbar().bringToFront()};X.prototype.onPopupClose=function(e){if(e.getParameters().isA("sap.m.Dialog")){this.getToolbar().setColor()}};X.prototype.setPlugins=function(e){if(this._sStatus!==Y){throw new Error("Cannot replace plugins: runtime authoring already started")}this.getPluginManager().setPlugins(e)};X.prototype.getPlugins=function(){return this.getPluginManager&&this.getPluginManager()&&this.getPluginManager().getPlugins()};X.prototype.getDefaultPlugins=function(){return this.getPluginManager().getDefaultPlugins(this.getFlexSettings())};X.prototype.setFlexSettings=function(e){var t=i.fromQuery(window.location.search);var n=t.get("sap-ui-layer");e=jQuery.extend({},this.getFlexSettings(),e);if(n){e.layer=n.toUpperCase()}if(e.scenario||e.baseId){var o=E.buildLrepRootNamespace(e.baseId,e.scenario,e.projectId);e.rootNamespace=o;e.namespace=o+"changes/"}K.setRtaStyleClassName(e.layer);this.setProperty("flexSettings",e)};X.prototype.getLayer=function(){return this.getFlexSettings().layer};X.prototype.getRootControlInstance=function(){if(!this._oRootControl){this._oRootControl=d.getElementInstance(this.getRootControl())}return this._oRootControl};X.prototype._getTextResources=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta")};X.prototype._setVersionsModel=function(e){this._oVersionsModel=e};X.prototype._initVersioning=function(){return S.initialize({control:this.getRootControlInstance(),layer:this.getLayer()}).then(this._setVersionsModel.bind(this))};X.prototype._onPersonalizationChangeCreation=function(){if(this.getMode()==="navigation"&&!this._bNavigationModeWarningShown){this._showMessageToast("MSG_NAVIGATION_MODE_CHANGES_WARNING",{duration:5e3});this._bNavigationModeWarningShown=true}};function $(e,t){if(e.isA("sap.ui.core.UIComponent")){e=e.getRootControl()}if(e){e[t?"addStyleClass":"removeStyleClass"]("sapUiRtaRoot")}}X.prototype.start=function(){var e;var t;if(this._sStatus===Y){this._sStatus=W;var i=this.getRootControlInstance();if(!i){t=new Error("Root control not found");n.error(t);return Promise.reject(t)}return this._loadUShellServicesPromise.then(this._initVersioning.bind(this)).then(function(){return N.handleReloadOnStart({layer:this.getLayer(),selector:this.getRootControlInstance(),versioningEnabled:this._oVersionsModel.getProperty("/versioningEnabled"),developerMode:this.getFlexSettings().developerMode})}.bind(this)).then(function(t){if(t){return Promise.reject("Reload triggered")}var i=y.getResetAndPublishInfoFromSession(this.getRootControlInstance());this.bInitialResetEnabled=!!i.isResetEnabled;this.bInitialPublishEnabled=!!i.isPublishEnabled;this._oSerializer=new D({commandStack:this.getCommandStack(),rootControl:this.getRootControl()});this.getPluginManager().preparePlugins(this.getFlexSettings(),this._handleElementModified.bind(this),this.getCommandStack());var n=this.getPluginManager().getPluginList();e=new Promise(function(e,t){T.start("rta.dt.startup","Measurement of RTA: DesignTime start up");this._oDesignTime=new l({scope:this.getMetadataScope(),plugins:n});$(this.getRootControlInstance(),true);this._oDesignTime.addRootElement(this._oRootControl);jQuery(u.getOverlayContainer()).addClass("sapUiRta");if(this.getLayer()===R.USER){jQuery(u.getOverlayContainer()).addClass("sapUiRtaPersonalize")}else{jQuery("body").addClass("sapUiRtaMode")}this._oDesignTime.getSelectionManager().attachChange(function(e){this.fireSelectionChange({selection:e.getParameter("selection")})},this);this._oDesignTime.attachEventOnce("synced",function(){e();T.end("rta.dt.startup","Measurement of RTA: DesignTime start up")},this);this._oDesignTime.attachEventOnce("syncFailed",function(e){t(e.getParameter("error"))})}.bind(this));this._oldUnloadHandler=window.onbeforeunload;window.onbeforeunload=this._onUnload.bind(this);return undefined}.bind(this)).then(function(){if(this.getShowToolbars()){return this._getToolbarButtonsVisibility().then(this._createToolsMenu.bind(this))}return undefined}.bind(this)).then(this._onStackModified.bind(this)).then(function(){u.getOverlayContainer().get(0).style.setProperty("--sap-ui-rta-scrollbar-scrollWidth",h.getScrollbarWidth()+"px");u.getOverlayContainer().get(0).style.setProperty("--sap-ui-rta-scrollbar-scrollWidthPlusTwo",h.getScrollbarWidth()+2+"px");return e}).then(function(){this.getPopupManager().setRta(this);if(this.getShowToolbars()){return this.getToolbar().show()}return undefined}.bind(this)).then(function(){if(j.browser.name==="ff"){jQuery(document).on("contextmenu",ee)}}).then(function(){this.fnKeyDown=this._onKeyDown.bind(this);jQuery(document).on("keydown",this.fnKeyDown);this.fnOnPersonalizationChangeCreation=this._onPersonalizationChangeCreation.bind(this);b.attachChangeCreation(this.getRootControlInstance(),this.fnOnPersonalizationChangeCreation)}.bind(this)).then(this._shouldValidateFlexEnabled).then(function(e){if(e){G(this)}this._sStatus=H;this.fireStart({editablePluginsCount:this.getPluginManager().getEditableOverlaysCount()})}.bind(this)).catch(function(e){if(e==="Reload triggered"){this.destroy()}else{this._sStatus=Z;this.fireFailed({error:e})}return Promise.reject(e)}.bind(this))}return Promise.reject("RuntimeAuthoring is already started")};function ee(){return false}X.prototype._getToolbarButtonsVisibility=function(){return Promise.all([m.isPublishAvailable(),M.isSaveAsAvailable(this.getRootControlInstance(),this.getLayer(),this._oSerializer),m.isContextBasedAdaptationAvailable(this.getLayer())]).then(function(e){var t=e[0];var i=e[1];var n=e[2];return{publishAvailable:t,saveAsAvailable:t&&i,contextBasedAdaptationAvailable:n}})};X.prototype._isOldVersionDisplayed=function(){return S.isOldVersionDisplayed({control:this.getRootControlInstance(),layer:this.getLayer()})};X.prototype._isDraftAvailable=function(){return S.isDraftAvailable({control:this.getRootControlInstance(),layer:this.getLayer()})};function te(e){s.hide();var t=e.userMessage||e.stack||e.message||e.status||e;var i=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");n.error("Failed to transfer changes",t);var r=i.getText("MSG_LREP_TRANSFER_ERROR")+"\n"+i.getText("MSG_ERROR_REASON",t);o.error(r,{styleClass:K.getRtaStyleClassName()})}X.prototype.setCommandStack=function(e){var t=this.getProperty("commandStack");if(t){t.detachModified(this._onStackModified,this)}if(this._oInternalCommandStack){this._oInternalCommandStack.destroy();delete this._oInternalCommandStack}var i=this.setProperty("commandStack",e);if(e){e.attachModified(this._onStackModified,this)}if(this.getPluginManager&&this.getPluginManager()){this.getPluginManager().provideCommandStack("settings",e)}return i};X.prototype.getCommandStack=function(){var e=this.getProperty("commandStack");if(!e){e=new I;this._oInternalCommandStack=e;this.setCommandStack(e)}return e};X.prototype._onStackModified=function(){var e=this._oVersionsModel.getProperty("/backendDraft");var t=this._oVersionsModel.getProperty("/displayedVersion")===f.Number.Draft;var i=this.getCommandStack();var n=i.canUndo();if(!this.getShowToolbars()||!n||this._bUserDiscardedDraft||t||!e){return this._modifyStack()}return K.showMessageBox("warning","MSG_DRAFT_DISCARD_AND_CREATE_NEW_DIALOG",{titleKey:"TIT_DRAFT_DISCARD_DIALOG",actions:[o.Action.OK,o.Action.CANCEL],emphasizedAction:o.Action.OK}).then(function(e){if(e===o.Action.OK){this._discardDraftConfirmed()}else{this.undo()}}.bind(this))};X.prototype._discardDraftConfirmed=function(){this._bUserDiscardedDraft=true;this._modifyStack()};X.prototype._modifyStack=function(){if(this.getShowToolbars()){var e=this.getCommandStack();var t=e.canUndo();var i=e.canRedo();var n=this._oToolbarControlsModel.getProperty("/translationVisible")&&C.hasTranslationRelevantDirtyChanges({layer:R.CUSTOMER,selector:this.getRootControlInstance()});this._oVersionsModel.setDirtyChanges(t);this._oToolbarControlsModel.setProperty("/undoEnabled",t);this._oToolbarControlsModel.setProperty("/redoEnabled",i);this._oToolbarControlsModel.setProperty("/publishEnabled",this.bInitialPublishEnabled||t);this._oToolbarControlsModel.setProperty("/restoreEnabled",this.bInitialResetEnabled||t);this._oToolbarControlsModel.setProperty("/translationEnabled",this.bPersistedDataTranslatable||n)}this.fireUndoRedoStackModified();return Promise.resolve()};X.prototype._checkToolbarAndExecuteFunction=function(e,t){if(this.getShowToolbars()&&this.getToolbar&&this.getToolbar()){return this.getToolbar()[e](t)}return undefined};X.prototype.getSelection=function(){if(this._oDesignTime){return this._oDesignTime.getSelectionManager().get()}return[]};function ie(){return Promise.resolve(this._oDesignTime&&this._oDesignTime.waitForBusyPlugins()).then(function(){return this._pElementModified}.bind(this))}X.prototype.stop=function(e,t){this._checkToolbarAndExecuteFunction("setBusy",true);var i;return ie.call(this).then(function(){if(t){return{}}return N.checkReloadOnExit({layer:this.getLayer(),selector:this.getRootControlInstance(),isDraftAvailable:this._oVersionsModel.getProperty("/draftAvailable"),versioningEnabled:this._oVersionsModel.getProperty("/versioningEnabled"),activeVersion:this._oVersionsModel.getProperty("/activeVersion"),changesNeedReloadPromise:this._bSavedChangesNeedReload?Promise.resolve(true):this._oSerializer.needsReload()})}.bind(this)).then(function(t){i=t;return e?Promise.resolve():this._serializeToLrep(this)}.bind(this)).then(this._checkToolbarAndExecuteFunction.bind(this,"hide",e)).then(function(){this.fireStop();if(!t){N.handleUrlParametersOnExit(i)}}.bind(this)).catch(te).then(function(){this._checkToolbarAndExecuteFunction("setBusy",false);this._sStatus=Y;jQuery("body").removeClass("sapUiRtaMode")}.bind(this))};X.prototype.restore=function(){return this._onRestore()};X.prototype.transport=function(){return this._onTransport()};X.prototype.undo=function(){return this._onUndo()};X.prototype.redo=function(){return this._onRedo()};X.prototype.canUndo=function(){return this.getCommandStack().canUndo()};X.prototype.canRedo=function(){return this.getCommandStack().canRedo()};X.prototype._onKeyDown=function(e){var t=j.os.macintosh;var i=u.getOverlayContainer().get(0).contains(document.activeElement);var n=this.getShowToolbars()&&this.getToolbar().getDomRef().contains(document.activeElement);var o=false;jQuery(".sapUiDtContextMenu").each(function(e,t){if(t.contains(document.activeElement)){o=true}});var r=document.body===document.activeElement;var a=jQuery(document.activeElement).parents(".sapUiRtaEditableField").length>0;if((i||n||o||r)&&!a){var s=t?e.metaKey:e.ctrlKey;if(e.keyCode===g.Z&&e.shiftKey===false&&e.altKey===false&&s===true){this._onUndo().then(e.stopPropagation.bind(e))}else if((t&&e.keyCode===g.Z&&e.shiftKey===true||!t&&e.keyCode===g.Y&&e.shiftKey===false)&&e.altKey===false&&s===true){this._onRedo().then(e.stopPropagation.bind(e))}}};X.prototype._onUnload=function(){var e=this.getCommandStack();var t=e.canUndo();if(t&&this.getShowWindowUnloadDialog()){return this._getTextResources().getText("MSG_UNSAVED_CHANGES")}window.onbeforeunload=this._oldUnloadHandler;return undefined};X.prototype._saveOnly=function(e){var t=e.getParameter("callback")||function(){};return ie.call(this).then(this._serializeToLrep.bind(this)).then(t)};X.prototype._serializeAndSave=function(e){if(this.getShowToolbars()){this.bPersistedDataTranslatable=this._oToolbarControlsModel.getProperty("/translationEnabled")}var t={saveAsDraft:this._oVersionsModel.getProperty("/versioningEnabled")&&this.getLayer()===R.CUSTOMER,layer:this.getLayer(),removeOtherLayerChanges:true,version:e?this._oVersionsModel.getProperty("/displayedVersion"):undefined};return this._oSerializer.saveCommands(t)};X.prototype._serializeToLrep=function(){if(!this._bSavedChangesNeedReload){return this._oSerializer.needsReload().then(function(e){this._bSavedChangesNeedReload=e;return this._serializeAndSave()}.bind(this))}return this._serializeAndSave()};X.prototype._onUndo=function(){this.getPluginManager().handleStopCutPaste();return this.getCommandStack().undo()};X.prototype._onRedo=function(){this.getPluginManager().handleStopCutPaste();return this.getCommandStack().redo()};X.prototype._onActivate=function(e){var t=e.getParameter("versionTitle");if(this._isOldVersionDisplayed()&&this._isDraftAvailable()){return K.showMessageBox("warning","MSG_DRAFT_DISCARD_ON_REACTIVATE_DIALOG",{titleKey:"TIT_DRAFT_DISCARD_ON_REACTIVATE_DIALOG",actions:[o.Action.OK,o.Action.CANCEL],emphasizedAction:o.Action.OK}).then(function(e){if(e===o.Action.OK){return this._activate(t)}}.bind(this))}return this._activate(t)};X.prototype._activate=function(e){var t=this.getLayer();var i=this.getRootControlInstance();var n=this._oVersionsModel.getProperty("/displayedVersion");return this._serializeAndSave(true).then(function(){return S.activate({layer:t,control:i,title:e,displayedVersion:n})}).then(function(){this._showMessageToast("MSG_DRAFT_ACTIVATION_SUCCESS");this.bInitialResetEnabled=true;this._oToolbarControlsModel.setProperty("/restoreEnabled",true);this.getCommandStack().removeAllCommands()}.bind(this)).catch(function(e){K.showMessageBox("error","MSG_DRAFT_ACTIVATION_FAILED",{error:e})})};X.prototype._handleDiscard=function(){var e=this.getLayer();var t={layer:e,removeDraft:true};X.enableRestart(e,this.getRootControlInstance());this.getCommandStack().removeAllCommands();N.triggerReload(t);return this.stop(true,true)};X.prototype._onDiscardDraft=function(){return K.showMessageBox("warning","MSG_DRAFT_DISCARD_DIALOG",{actions:[o.Action.OK,o.Action.CANCEL],emphasizedAction:o.Action.OK}).then(function(e){if(e===o.Action.OK){return S.discardDraft({layer:this.getLayer(),control:this.getRootControlInstance(),updateState:true}).then(this._handleDiscard.bind(this))}return undefined}.bind(this))};X.prototype._onSwitchVersion=function(e){var t=e.getParameter("version");var i=this._oVersionsModel.getProperty("/displayedVersion");if(t===i){return}if(this.canUndo()){this._sSwitchToVersion=t;K.showMessageBox("warning","MSG_SWITCH_VERSION_DIALOG",{titleKey:"TIT_SWITCH_VERSION_DIALOG",actions:[o.Action.YES,o.Action.NO,o.Action.CANCEL],emphasizedAction:o.Action.YES}).then(function(e){if(e===o.Action.YES){this._serializeToLrep(this).then(this._switchVersion.bind(this,this._sSwitchToVersion))}else if(e===o.Action.NO){this.getCommandStack().removeAllCommands(true);this._switchVersion(this._sSwitchToVersion)}return undefined}.bind(this));return}this._switchVersion(t)};X.prototype._switchVersion=function(e){X.enableRestart(this.getLayer(),this.getRootControlInstance());S.loadVersionForApplication({control:this.getRootControlInstance(),layer:this.getLayer(),version:e});var t={versionSwitch:true,version:e};N.triggerReload(t)};X.prototype._createToolsMenu=function(e){if(!this.getDependent("toolbar")){var t=this.getLayer()===R.USER;var n={rtaInformation:{flexSettings:this.getFlexSettings(),rootControl:this.getRootControlInstance(),commandStack:this.getCommandStack()},textResources:this._getTextResources(),restore:this._onRestore.bind(this),exit:this.stop.bind(this,false,t),save:this._saveOnly.bind(this)};if(!t){n.transport=this._onTransport.bind(this);n.publishVersion=this._onPublishVersion.bind(this);n.undo=this._onUndo.bind(this);n.redo=this._onRedo.bind(this);n.modeChange=this._onModeChange.bind(this);n.activate=this._onActivate.bind(this);n.discardDraft=this._onDiscardDraft.bind(this);n.switchVersion=this._onSwitchVersion.bind(this);n.openChangeCategorySelectionPopover=this.getChangeVisualization?this.getChangeVisualization().openChangeCategorySelectionPopover.bind(this.getChangeVisualization()):function(){}}var o;if(t){o=new L(n)}else if(K.isOriginalFioriToolbarAccessible()){o=new V(n)}else if(K.getFiori2Renderer()){o=new x(n)}else{o=new U(n)}this.addDependent(o,"toolbar");return Promise.all([o.onFragmentLoaded(),m.isKeyUserTranslationEnabled(this.getLayer())]).then(function(t){var n=t[1];var o=e.saveAsAvailable;var r=o&&M.isOverviewExtended();var a=i.fromURL(window.location.href);var s;s=!a.has("fiori-tools-rta-mode")||a.get("fiori-tools-rta-mode")==="false";this.bPersistedDataTranslatable=false;this._oToolbarControlsModel=new A({undoEnabled:false,redoEnabled:false,translationVisible:n,translationEnabled:this.bPersistedDataTranslatable,publishVisible:e.publishAvailable,publishEnabled:this.bInitialPublishEnabled,restoreEnabled:this.bInitialResetEnabled,appVariantsOverviewVisible:o&&r,appVariantsOverviewEnabled:o&&r,saveAsVisible:o,contextBasedAdaptationVisible:e.contextBasedAdaptationAvailable,saveAsEnabled:false,manageAppsVisible:o&&!r,manageAppsEnabled:o&&!r,modeSwitcher:this.getMode(),visualizationButtonVisible:s});var l=new Promise(function(e){if(!n){e();return}C.getSourceLanguages({selector:this.getRootControlInstance(),layer:this.getLayer()}).then(function(e){this.bPersistedDataTranslatable=e.length>0;this._oToolbarControlsModel.setProperty("/translationEnabled",this.bPersistedDataTranslatable)}.bind(this)).finally(e)}.bind(this));var h=new Promise(function(e){if(!o){e();return}M.isManifestSupported().then(function(e){this._oToolbarControlsModel.setProperty("/saveAsEnabled",e);this._oToolbarControlsModel.setProperty("/appVariantsOverviewEnabled",e);this._oToolbarControlsModel.setProperty("/manageAppsEnabled",e)}.bind(this)).finally(e)}.bind(this));this.getToolbar().setModel(this._oVersionsModel,"versions");this.getToolbar().setModel(this._oToolbarControlsModel,"controls");return Promise.all([l,h])}.bind(this))}return Promise.resolve()};X.prototype.destroy=function(){jQuery.map(this._dependents,function(e,t){this.removeDependent(t);e.destroy(true)}.bind(this));Object.keys(this._mServices).forEach(function(e){this.stopService(e)},this);if(this._oDesignTime){this._oDesignTime.destroy();this._oDesignTime=null;jQuery(document).off("keydown",this.fnKeyDown);if(this.fnOnPersonalizationChangeCreation){b.detachChangeCreation(this.getRootControlInstance(),this.fnOnPersonalizationChangeCreation)}}if(this.getRootControlInstance()){$(this.getRootControlInstance(),false)}this.setCommandStack(null);if(this._oServiceEventBus){this._oServiceEventBus.destroy()}if(j.browser.name==="ff"){jQuery(document).off("contextmenu",ee)}window.onbeforeunload=this._oldUnloadHandler;a.prototype.destroy.apply(this,arguments)};X.prototype._onPublishVersion=function(){this.getPluginManager().handleStopCutPaste();return S.publish({selector:this.getRootControlInstance(),styleClass:K.getRtaStyleClassName(),layer:this.getLayer(),version:this._oVersionsModel.getProperty("/displayedVersion")}).then(function(e){if(e!=="Error"&&e!=="Cancel"){r.show(e)}})};X.prototype._onTransport=function(){this.getPluginManager().handleStopCutPaste();s.show(500);return this._serializeToLrep().then(function(){s.hide();var e=E.isVariantByStartupParameter(this._oRootControl);var t=v.isApplicationVariant({control:this._oRootControl})&&!e;return(t?M.getAppVariantDescriptor(this._oRootControl):Promise.resolve()).then(function(e){var t=[];if(e){t.push(e)}return y.publish({selector:this.getRootControlInstance(),styleClass:K.getRtaStyleClassName(),layer:this.getLayer(),appVariantDescriptors:t}).then(function(e){if(e!=="Error"&&e!=="Cancel"){r.show(e);if(this.getShowToolbars()){y.getResetAndPublishInfo({selector:this.getRootControlInstance(),layer:this.getLayer()}).then(function(e){this._oToolbarControlsModel.setProperty("/publishEnabled",e.isPublishEnabled);this._oToolbarControlsModel.setProperty("/restoreEnabled",e.isResetEnabled)}.bind(this))}}}.bind(this))}.bind(this))}.bind(this))["catch"](te)};X.prototype._deleteChanges=function(){var e=this.getLayer();var t=E.getAppComponentForControl(this.getRootControlInstance());return y.reset({selector:t,layer:e}).then(function(){this.getCommandStack().removeAllCommands(true);_.removeInfoSessionStorage(t);var i={layer:e,ignoreMaxLayerParameter:true,triggerHardReload:true};return N.triggerReload(i)}.bind(this)).catch(function(e){if(e!=="cancel"){K.showMessageBox("error","MSG_RESTORE_FAILED",{error:e})}})};X.prototype._showMessageToast=function(e,t){var i=this._getTextResources().getText(e);r.show(i,t||{})};X.needsRestart=function(e){return N.needsAutomaticStart(e)};X.enableRestart=function(e,t){N.enableAutomaticStart(e,t)};X.disableRestart=function(e){N.disableAutomaticStart(e)};X.prototype._onRestore=function(){var e=this.getLayer();var t=e===R.USER?"FORM_PERS_RESET_MESSAGE_PERSONALIZATION":"FORM_PERS_RESET_MESSAGE";var i=e===R.USER?"BTN_RESTORE":"FORM_PERS_RESET_TITLE";this.getPluginManager().handleStopCutPaste();return K.showMessageBox("warning",t,{titleKey:i,actions:[o.Action.OK,o.Action.CANCEL],emphasizedAction:o.Action.OK}).then(function(t){if(t===o.Action.OK){X.enableRestart(e,this.getRootControlInstance());return this._deleteChanges()}return undefined}.bind(this))};X.prototype._scheduleOnCreated=function(e,t){function i(n){var o=n.getParameter("elementOverlay");if(o.getElement().getId()===e){this._oDesignTime.detachEvent("elementOverlayCreated",i,this);t(o)}}this._oDesignTime.attachEvent("elementOverlayCreated",i,this)};X.prototype._scheduleOnCreatedAndVisible=function(e,t){function i(e){var n=e.getSource();if(n.getGeometry()&&n.getGeometry().visible){n.detachEvent("geometryChanged",i);t(n)}}function n(e){if(!e.getGeometry()||!e.getGeometry().visible){e.attachEvent("geometryChanged",i)}else{t(e)}}this._scheduleOnCreated(e,function(e){if(e.isRendered()){n(e)}else{e.attachEventOnce("afterRendering",function(e){n(e.getSource())})}})};X.prototype._scheduleRenameOnCreatedContainer=function(e,t){var i=function(e){e.setSelected(true);this.getPluginManager().getPlugin("rename").startEdit(e)}.bind(this);this._scheduleOnCreatedAndVisible(t,function(t){var n=this.getPluginManager().getPlugin("createContainer").getCreatedContainerId(e,t.getElement().getId());var o=c.getOverlay(n);if(o){i(o)}else{this._scheduleOnCreatedAndVisible(n,i)}}.bind(this))};X.prototype._handleElementModified=function(e){var t=e.getParameter("command");var i=e.getParameter("newControlId");var o=e.getParameter("action");this._pElementModified=this._pElementModified.then(function(){this.getPluginManager().handleStopCutPaste();if(t instanceof w){if(i){this._scheduleOnCreated(i,function(e){var t=e.getDesignTimeMetadata();var i=t.getData().select;if(typeof i==="function"){i(e.getElement())}});if(o){this._scheduleRenameOnCreatedContainer(o,i)}}return this.getCommandStack().pushAndExecute(t).catch(function(e){if(e&&e.message&&e.message.indexOf("The following Change cannot be applied because of a dependency")>-1){K.showMessageBox("error","MSG_DEPENDENCY_ERROR",{error:e})}n.error("sap.ui.rta: "+e.message)})}}.bind(this));return this._pElementModified};X.prototype._onModeChange=function(e){this.setMode(e.getParameter("item").getKey())};X.prototype.setMode=function(e){var t=this.getMode();if(t!==e){var i=this.getPluginManager().getPlugin("tabHandling");var n=this.getPluginManager().getPlugin("selection");if(t==="navigation"||e==="navigation"){this._oDesignTime.setEnabled(e!=="navigation");i[e==="navigation"?"restoreTabIndex":"removeTabIndex"]()}var o=this.getChangeVisualization&&this.getChangeVisualization();if(e==="visualization"||t==="visualization"){p.waitForSynced(this._oDesignTime)().then(function(){return o.triggerModeChange(this.getRootControl(),this.getToolbar())}.bind(this))}if(t==="adaptation"){this.getPluginManager().handleStopCutPaste()}i[e==="adaptation"?"restoreOverlayTabIndex":"removeOverlayTabIndex"]();n.setIsActive(!(e==="visualization"));u.getOverlayContainer().toggleClass("sapUiRtaVisualizationMode",e==="visualization");if(e==="visualization"){jQuery(".sapUiDtOverlayMovable").css("cursor","default")}else{jQuery(".sapUiDtOverlayMovable").css("cursor","move")}this._oToolbarControlsModel.setProperty("/modeSwitcher",e);this.setProperty("mode",e);this.fireModeChanged({mode:e})}};X.prototype.setMetadataScope=function(e){if(this._sStatus!==Y){n.error("sap.ui.rta: Failed to set metadata scope on RTA instance after RTA is started");return}this.setProperty("metadataScope",e)};function ne(e){if(O.hasOwnProperty(e)){return O[e].replace(/\./g,"/")}return undefined}X.prototype.startService=function(e){if(this._sStatus!==H){return new Promise(function(e,t){this.attachEventOnce("start",e);this.attachEventOnce("failed",t)}.bind(this)).then(function(){return this.startService(e)}.bind(this),function(){return Promise.reject(p.createError("RuntimeAuthoring#startService",p.printf("Can't start the service '{0}' while RTA has been failed during a startup",e),"sap.ui.rta"))})}var i=ne(e);var n;if(!i){return Promise.reject(p.createError("RuntimeAuthoring#startService",p.printf("Unknown service. Can't find any registered service by name '{0}'",e),"sap.ui.rta"))}n=this._mServices[e];if(n){switch(n.status){case Q:{return Promise.resolve(n.exports)}case q:{return n.initPromise}case J:{return n.initPromise}default:{return Promise.reject(p.createError("RuntimeAuthoring#startService",p.printf("Unknown service status. Service name = '{0}'",e),"sap.ui.rta"))}}}else{this._mServices[e]=n={status:q,location:i,initPromise:new Promise(function(o,r){sap.ui.require([i],function(i){n.factory=i;if(!this._oServiceEventBus){this._oServiceEventBus=new B}p.wrapIntoPromise(i)(this,this._oServiceEventBus.publish.bind(this._oServiceEventBus,e)).then(function(i){if(this.bIsDestroyed){throw p.createError("RuntimeAuthoring#startService",p.printf("RuntimeAuthoring instance is destroyed while initializing the service '{0}'",e),"sap.ui.rta")}if(!t(i)){throw p.createError("RuntimeAuthoring#startService",p.printf("Invalid service format. Service should return simple javascript object after initialization. Service name = '{0}'",e),"sap.ui.rta")}n.service=i;n.exports={};if(Array.isArray(i.events)&&i.events.length>0){jQuery.extend(n.exports,{attachEvent:this._oServiceEventBus.subscribe.bind(this._oServiceEventBus,e),detachEvent:this._oServiceEventBus.unsubscribe.bind(this._oServiceEventBus,e),attachEventOnce:this._oServiceEventBus.subscribeOnce.bind(this._oServiceEventBus,e)})}var r=i.exports||{};jQuery.extend(n.exports,Object.keys(r).reduce(function(e,t){var i=r[t];e[t]=typeof i==="function"?p.waitForSynced(this._oDesignTime,i):i;return e}.bind(this),{}));n.status=Q;o(Object.freeze(n.exports))}.bind(this)).catch(r)}.bind(this),function(t){n.status=J;r(p.propagateError(t,"RuntimeAuthoring#startService",p.printf("Can't load service '{0}' by its name: {1}",e,i),"sap.ui.rta"))})}.bind(this)).catch(function(t){n.status=J;return Promise.reject(p.propagateError(t,"RuntimeAuthoring#startService",p.printf("Error during service '{0}' initialization.",e),"sap.ui.rta"))})};return n.initPromise}};X.prototype.stopService=function(e){var t=this._mServices[e];if(t){if(t.status===Q){if(typeof t.service.destroy==="function"){t.service.destroy()}}delete this._mServices[e]}else{throw p.createError("RuntimeAuthoring#stopService",p.printf("Can't destroy service: unable to find service with name '{0}'",e),"sap.ui.rta")}};X.prototype.getService=function(e){return this.startService(e)};X.prototype._getUShellService=function(e){return E.getUshellContainer()&&this._mUShellServices[e]};return X});
//# sourceMappingURL=RuntimeAuthoring.js.map