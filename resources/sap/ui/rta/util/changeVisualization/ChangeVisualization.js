/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Fragment","sap/base/util/restricted/_difference","sap/base/util/deepEqual","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Control","sap/ui/dt/OverlayRegistry","sap/ui/dt/ElementUtil","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/model/resource/ResourceModel","sap/ui/model/json/JSONModel","sap/ui/rta/util/changeVisualization/ChangeIndicator","sap/ui/rta/util/changeVisualization/ChangeIndicatorRegistry","sap/ui/rta/util/changeVisualization/ChangeCategories"],function(e,t,n,o,a,i,r,s,g,l,h,u,c,d,C){"use strict";function p(){var e=this.getPopover();if(e&&e.isOpen()){e.close()}}var f=a.extend("sap.ui.rta.util.changeVisualization.ChangeVisualization",{metadata:{library:"sap.ui.rta",properties:{rootControlId:{type:"string"},isActive:{type:"boolean",defaultValue:false}},aggregations:{popover:{type:"sap.m.Popover",multiple:false}}},constructor:function(){this._oChangeIndicatorRegistry=new d({changeCategories:C.getCategories()});a.prototype.constructor.apply(this,arguments);this._oTextBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");this.setModel(new h({bundle:this._oTextBundle}),"i18n");this._oChangeVisualizationModel=new u({active:this.getIsActive()});this._oChangeVisualizationModel.setDefaultBindingMode("OneWay");this._sSelectedChangeCategory=C.ALL;this._bSetModeChanged=false;this._fnOnClickHandler=p.bind(this)}});f.prototype.setRootControlId=function(e){if(this.getRootControlId()&&this.getRootControlId()!==e){this._reset()}this.setProperty("rootControlId",e);this._oChangeIndicatorRegistry.setRootControlId(e)};f.prototype._getComponent=function(){return l.getAppComponentForControl(r.getElementInstance(this.getRootControlId()))};f.prototype.setIsActive=function(e){if(e===this.getIsActive()){return}this.setProperty("isActive",e);if(this._oChangeVisualizationModel){this._updateVisualizationModel({active:e})}};f.prototype.exit=function(){this._oChangeIndicatorRegistry.destroy();this._toggleRootOverlayClickHandler(false)};f.prototype._reset=function(){this._oChangeIndicatorRegistry.reset()};f.prototype._updateVisualizationModelMenuData=function(){var e=this._oChangeVisualizationModel.getData().visualizedChanges;var t=[];var n=this._oChangeIndicatorRegistry.getAllRegisteredChanges();n.forEach(function(n){var o=e.find(function(e){return n.change.getId()===e.id});if(!o&&!n.dependent){t.push(n)}});var o=Object.keys(C.getCategories()).map(function(t){var n=this._getChangeCategoryLabel(t,this._getChangesForChangeCategory(t,e).length);return{key:t,count:this._getChangesForChangeCategory(t,e).length,title:n,icon:C.getIconForCategory(t)}}.bind(this));o.unshift({key:C.ALL,count:this._getChangesForChangeCategory(C.ALL,e).length,title:this._getChangeCategoryLabel(C.ALL,this._getChangesForChangeCategory(C.ALL,e).length),icon:C.getIconForCategory(C.ALL)});this._updateVisualizationModel({changeCategories:o,hiddenChanges:t,popupInfoMessage:this._oTextBundle.getText("MSG_CHANGEVISUALIZATION_HIDDEN_CHANGES_INFO",[t.length])})};f.prototype._getChangesForChangeCategory=function(e,t){return t.filter(function(t){return e===C.ALL?t.changeCategory!==undefined:e===t.changeCategory})};f.prototype._getChangeCategoryLabel=function(e,t){var n="TXT_CHANGEVISUALIZATION_OVERVIEW_"+e.toUpperCase();return this._oTextBundle.getText(n,[t])};f.prototype._getChangeCategoryButton=function(e){var t="BTN_CHANGEVISUALIZATION_OVERVIEW_"+e.toUpperCase();return this._oTextBundle.getText(t)};f.prototype.openChangeCategorySelectionPopover=function(t){if(!this._oToolbarButton){this._oToolbarButton=sap.ui.getCore().byId(t.getParameter("id"))}var n=this.getPopover();if(!n){e.load({name:"sap.ui.rta.util.changeVisualization.ChangeIndicatorCategorySelection",id:this._getComponent().createId("changeVisualization_changesListPopover"),controller:this}).then(function(e){this._oToolbarButton.addDependent(e);e.setModel(this._oChangeVisualizationModel,"visualizationModel");e.openBy(this._oToolbarButton);this.setPopover(e)}.bind(this));return}if(n.isOpen()){n.close()}else{n.openBy(this._oToolbarButton)}};f.prototype.onChangeCategorySelection=function(e){var t=e.getSource().getBindingContext("visualizationModel").getObject().key;this._selectChangeCategory(t)};f.prototype._selectChangeCategory=function(e){this._sSelectedChangeCategory=e;var t=this._getChangeCategoryButton(e);this._updateVisualizationModel({changeCategory:e,changeCategoryText:t});this._updateChangeIndicators();this._setFocusedIndicator()};f.prototype._getCommandForChange=function(e){var t=e.getSupportInformation().command;if(t){return t}var n=this._getComponent();var a=o.bySelector(e.getSelector(),n);var r=e.getDependentSelectorList().slice(-1)[0];var s=o.bySelector(r,n);function g(t,n){var o=t.getElement();var i=t.getDesignTimeMetadata().getCommandName(e.getChangeType(),o,n);if(i){return i}var r=t.getParentElementOverlay();var s=t.getParentAggregationOverlay();if(t.getElement().getId()===a.getId()||!r){return undefined}return g(r,s&&s.getAggregationName())}return a&&s&&g(i.getOverlay(s))};f.prototype._collectChanges=function(){var e=this._getComponent();var t={selector:e,invalidateCache:false,currentLayer:g.CUSTOMER,includeDirtyChanges:true,onlyCurrentVariants:true};return s._getUIChanges(t)};f.prototype._updateChangeRegistry=function(){return this._collectChanges().then(function(e){var n=this._oChangeIndicatorRegistry.getRegisteredChangeIds();var o=e.filter(function(e){return e.getFileType()==="change"&&e.getSelector()}).reduce(function(e,t){e[t.getId()]=t;return e},{});var a=Object.keys(o);t(n,a).forEach(function(e){this._oChangeIndicatorRegistry.removeChange(e)}.bind(this));var i=[];t(a,n).forEach(function(e){var t=o[e];var n=this._getCommandForChange(t);i.push(this._oChangeIndicatorRegistry.registerChange(t,n))}.bind(this));return Promise.all(i)}.bind(this))};f.prototype.selectChange=function(e){var t=e.getParameter("changeId");this._selectChange(t)};f.prototype._selectChange=function(e){var t=this._oChangeIndicatorRegistry.getRegisteredChange(e).visualizationInfo.dependentElementIds;t.forEach(function(e){var t=i.getOverlay(e).getDomRef();t.scrollIntoViewIfNeeded();t.classList.add("sapUiRtaChangeIndicatorDependent");t.addEventListener("animationend",function(){t.classList.remove("sapUiRtaChangeIndicatorDependent")},{once:true})})};f.prototype._updateVisualizationModel=function(e){this._oChangeVisualizationModel.setData(Object.assign({},this._oChangeVisualizationModel.getData(),e))};f.prototype._updateChangeIndicators=function(){var e=this._oChangeIndicatorRegistry.getSelectorsWithRegisteredChanges();var t={};var o=[];Object.keys(e).forEach(function(n){var a=this._filterRelevantChanges(e[n]);var r=i.getOverlay(n);if(!r){a.some(function(e){var t=i.getOverlay(e.affectedElementId);var n=t&&t.getRelevantContainer();if(n){r=i.getOverlay(n);return true}return false})}if(!r||!r.getDomRef()||!r.isVisible()){return undefined}var s=r.getDomRef().getClientRects()[0]||{left:0,top:0};a.forEach(function(e){o.push(e)});t[n]={posX:parseInt(s.left),posY:parseInt(s.top),changes:a};var g=this._oChangeIndicatorRegistry.getChangeIndicator(n);var l=r.getId();if(!g){this._createChangeIndicator(r,n)}else if(g.getOverlayId()!==l){g.setOverlayId(l)}return undefined}.bind(this));if(!n(t,this._oChangeVisualizationModel.getData().content)||!n(o,this._oChangeVisualizationModel.getData().visualizedChanges)){this._updateVisualizationModel({content:t,visualizedChanges:o})}};f.prototype._filterRelevantChanges=function(e){if(!Array.isArray(e)){return e}var t=this._oChangeVisualizationModel.getData();return e.filter(function(e){return!e.dependent&&e.changeCategory&&(t.changeCategory===C.ALL||t.changeCategory===e.changeCategory)})};f.prototype._createChangeIndicator=function(e,t){var n=new c({changes:"{changes}",posX:"{posX}",posY:"{posY}",visible:"{= ${/active} && (${changes} || []).length > 0}",overlayId:e.getId(),selectorId:t,selectChange:this.selectChange.bind(this)});n.setModel(this._oChangeVisualizationModel);n.bindElement("/content/"+t);n.setModel(this.getModel("i18n"),"i18n");this._oChangeIndicatorRegistry.registerChangeIndicator(t,n)};f.prototype._setFocusedIndicator=function(){sap.ui.getCore().applyChanges();var e=this._oChangeIndicatorRegistry.getChangeIndicators().filter(function(e){return e.getVisible()}).sort(function(e,t){var n=e.getPosY()-t.getPosY();var o=e.getPosX()-t.getPosX();return n||o});if(e.length===0){return}e.forEach(function(e,t){e.getDomRef().tabIndex=t+2});e[0].focus()};f.prototype._toggleRootOverlayClickHandler=function(e){var t=this.oRootOverlay&&this.oRootOverlay.getDomRef();if(t){if(e){t.addEventListener("click",this._fnOnClickHandler,{capture:true})}else{t.removeEventListener("click",this._fnOnClickHandler,{capture:true})}}};f.prototype.triggerModeChange=function(e,t){this.oMenuButton=t.getControl("toggleChangeVisualizationMenuButton");this.oRootOverlay=i.getOverlay(e);if(this.getIsActive()){this.setIsActive(false);this._toggleRootOverlayClickHandler(false);return}this._toggleRootOverlayClickHandler(true);if(!this.getRootControlId()){this.setRootControlId(e)}this.setIsActive(true);this._updateChangeRegistry().then(function(){this._selectChangeCategory(this._sSelectedChangeCategory);this._updateVisualizationModelMenuData();t.setModel(this._oChangeVisualizationModel,"visualizationModel")}.bind(this))};return f});
//# sourceMappingURL=ChangeVisualization.js.map