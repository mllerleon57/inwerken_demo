/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/includes","sap/base/util/values","sap/base/util/restricted/_omit","sap/base/Log","sap/ui/base/ManagedObject","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/dt/ElementUtil","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/Utils","sap/ui/fl/changeHandler/common/ChangeCategories","sap/ui/core/Core"],function(e,t,n,i,o,a,r,s,g,d,c){"use strict";var u=o.extend("sap.ui.rta.util.changeVisualization.ChangeIndicatorRegistry",{metadata:{properties:{changeCategories:{type:"object",defaultValue:[]},rootControlId:{type:"string"}}},constructor:function(){o.prototype.constructor.apply(this,arguments);this._oRegisteredChanges={};this._oChangeIndicators={}}});u.prototype.exit=function(){this.reset()};u.prototype.getAllRegisteredChanges=function(){return t(this._oRegisteredChanges||{}).map(function(e){return Object.assign({},e)})};u.prototype.getRegisteredChangeIds=function(){return Object.keys(this._oRegisteredChanges||{})};u.prototype.getRegisteredChange=function(e){return this._oRegisteredChanges[e]&&Object.assign({},this._oRegisteredChanges[e])};u.prototype.getSelectorsWithRegisteredChanges=function(){var e={};function i(t,i,o,a){if(e[t]===undefined){e[t]=[]}e[t].push(Object.assign({id:o.change.getId(),dependent:a,affectedElementId:i,payload:o.visualizationInfo.payload||{}},n(o,["visualizationInfo"])))}t(this._oRegisteredChanges).forEach(function(e){e.visualizationInfo.displayElementIds.forEach(function(t,n){if(e.visualizationInfo.hasParentWithUnstableId){t=c.byId(t).getParent().getId()}i(t,e.visualizationInfo.affectedElementIds[n],e,false)});e.visualizationInfo.dependentElementIds.forEach(function(t){i(t,t,e,true)})});return e};u.prototype.getChangeIndicator=function(e){return this._oChangeIndicators[e]};u.prototype.getChangeIndicators=function(){return t(this._oChangeIndicators||{})};u.prototype.registerChange=function(t,n){var i=g.getAppComponentForControl(r.getElementInstance(this.getRootControlId()));return h(t,i).then(function(i){var o=this.getChangeCategories();var a;if(n==="settings"&&e(Object.keys(o),i.payload.category)){a=i.payload.category}else{a=Object.keys(o).find(function(t){return e(o[t],n)});if(!a){a=d.OTHER}}this._oRegisteredChanges[t.getId()]={change:t,commandName:n,changeCategory:a,visualizationInfo:i}}.bind(this))};function h(e,t){function n(e){if(!e){return undefined}return e.map(function(e){var n=typeof e.getId==="function"?e:a.bySelector(e,t);return n&&n.getId()}).filter(Boolean)}return f(t,e).then(function(t){var i=t||{};var o=n(i.affectedControls||[e.getSelector()]);return{affectedElementIds:o,dependentElementIds:n(i.dependentControls)||[],displayElementIds:n(i.displayControls)||o,hasParentWithUnstableId:i.hasParentWithUnstableId,payload:i.payload||{}}})}function f(e,t){var n=a.bySelector(t.getSelector(),e);if(n){return s.getChangeHandler({changeType:t.getChangeType(),element:n,modifier:a,layer:t.getLayer()}).then(function(n){if(n&&typeof n.getChangeVisualizationInfo==="function"){return n.getChangeVisualizationInfo(t,e)}return undefined}).catch(function(e){i.error(e);return undefined})}return Promise.resolve()}u.prototype.registerChangeIndicator=function(e,t){this._oChangeIndicators[e]=t};u.prototype.reset=function(){Object.keys(this._oRegisteredChanges).forEach(function(e){this.removeRegisteredChange(e)}.bind(this));t(this._oChangeIndicators).forEach(function(e){e.destroy()});this._oChangeIndicators={}};u.prototype.removeRegisteredChange=function(e){delete this._oRegisteredChanges[e]};return u});
//# sourceMappingURL=ChangeIndicatorRegistry.js.map